---
layout: layout/standard.njk
titre: "Conversion d'image automatique avec Eleventy"
tags: "recueil"
date: 2021-05-02
description: "Test de génération automatique d'image en WebP en Avif"
scriptJs: "prism.js"
styleCss: "prism.css"
---
{% import "macro/contenu.njk" as macro %}

<p class="mb-xl">
    Utilise le plugin <a href="https://www.11ty.dev/docs/plugins/image/" rel="external">Image d'Eleventy</a>
    <br><br>
    <code>npm install @11ty/eleventy-img</code>
</p>





{{ macro.h2("Convertis une image") }}

<p class="mb-s">
    Pour nommer l'image générée comme sa source j'utilise la function <code>filenameFormat</code> avec
    <a href="https://www.npmjs.com/package/path" rel="external">path</a>
</p>
<p class="mb-s">
    Dans <code>eleventy.js</code>
</p>

<div class="mb-xl">
    <pre><code class="language-javascript">const path = require("path");
const Image = require("@11ty/eleventy-img");

(async () => {
    let url = "sources/images/kirby/logo_kirby_super_star_ultra.png";
    let stats = await Image(url, {
        formats: ['avif', 'webp'],
        outputDir: './sources/images/_generated',
        filenameFormat: function (id, src, width, format, options) {
            const extension = path.extname(src);
            const name = path.basename(src, extension);
            return `${name}.${format}`;
        },
    })
    //console.log( stats );
})();

module.exports = function (eleventyConfig) {
    ...
};</code></pre>
</div>





{{ macro.h2("Convertis un dossier d'images") }}

<p class="mb-s">
    Installer <a href="https://www.npmjs.com/package/fast-glob" rel="external">fast-glob</a>
    <code>npm install fast-glob</code>
</p>
<p class="mb-s">
    Dans <code>eleventy.js</code>
</p>

<div class="mb-xl">
    <pre><code class="language-javascript">const path = require("path");
const Image = require("@11ty/eleventy-img");
const fg = require('fast-glob');

async function generateImages() {
    const dossierImages = fg.stream("sources/images/**/*.{jpg,jpeg,png}");
    for await (const entry of dossierImages) {

        let dossier = entry.substr(0,entry.lastIndexOf('/'));

        let stats = await Image(entry, {
            formats: ['avif', 'webp'],
            outputDir: dossier+'/auto',
            filenameFormat: function (id, src, width, format, options) {
                const extension = path.extname(src);
                const name = path.basename(src, extension);
                return `${name}.${format}`;
            },
        })
    }
}

module.exports = function (eleventyConfig) {

    //génère les images en webp et avif
    generateImages();
    console.log('images généré');

};</code></pre>

    <p class="pt-m">&#8627; Pas terrible, ca relace le watch pour chaque image, <strong>à désactiver après usage</strong></p>

</div>




{{ macro.h2("Exemple") }}

<div class="mb-s">
<pre><code class="language-html">&lt;img src=&quot;{{ metadata.siteUrl }}/images/mosaique/aux-delices-ahmed.jpg&quot; alt=&quot;normal&quot;&gt;
&lt;img src=&quot;{{ metadata.siteUrl }}/images/mosaique/auto/aux-delices-ahmed.webp&quot; alt=&quot;webp auto&quot;&gt;</code></pre>
</div>

<img src="{{ metadata.siteUrl }}/images/mosaique/aux-delices-ahmed.jpg" alt="normal">
<img src="{{ metadata.siteUrl }}/images/mosaique/auto/aux-delices-ahmed.webp" alt="webp auto">
